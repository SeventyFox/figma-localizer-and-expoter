<style>
  * {
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
  }

  @font-face {
    font-family: Inter;
    font-style: normal;
    font-weight: 400;
    src: url(https://rsms.me/inter/font-files/Inter-Regular.woff2?v=3.7) format("woff2"),
      url(https://rsms.me/inter/font-files/Inter-Regular.woff?v=3.7) format("woff");
  }

  @font-face {
    font-family: Inter;
    font-style: normal;
    font-weight: 500;
    src: url(https://rsms.me/inter/font-files/Inter-Medium.woff2?v=3.7) format("woff2"),
      url(https://rsms.me/inter/font-files/Inter-Medium.woff2?v=3.7) format("woff");
  }

  @font-face {
    font-family: Inter;
    font-style: normal;
    font-weight: 600;
    src: url(https://rsms.me/inter/font-files/Inter-SemiBold.woff2?v=3.7) format("woff2"),
      url(https://rsms.me/inter/font-files/Inter-SemiBold.woff2?v=3.7) format("woff");
  }

  html,
  body {
    font-family: Inter, sans-serif;
    font-size: 11px;
    font-weight: 400;
    height: 100%;
    letter-spacing: 0.005em;
    line-height: 16px;
    margin: 0;
    padding: 0;
    width: 100%;
  }

  .container {
    display: flex;
    flex-direction: column;
    padding: 0 8px 8px 8px;
    width: 100%;
  }

  .block {
    margin-top: 8px;
  }

  .row {
    display: flex;
    flex-direction: row;
  }

  .row * {
    margin-left: 8px;
  }

  .row *:last-child {
    margin-right: 8px;
  }

  .tab {
    -ms-flex-align: center;
    -webkit-box-align: center;
    align-items: center;
    border-bottom: 1px solid rgba(0, 0, 0, 0.3);
    color: rgba(0, 0, 0, 0.3);
    cursor: default;
    display: -ms-flexbox;
    display: -webkit-box;
    display: flex;
    font-weight: 500;
    height: 32px;
    justify-content: center;
    padding: 8px 0;
    width: 100%;
  }

  .tab--active {
    border-bottom: 1px solid rgba(0, 0, 0, 0.8);
    color: rgba(0, 0, 0, 0.8);
  }

  .label {
    -ms-flex-align: center;
    -webkit-box-align: center;
    align-items: center;
    color: rgba(0, 0, 0, 0.3);
    display: -ms-flexbox;
    display: -webkit-box;
    display: flex;
    height: 32px;
    padding: 8px 0;
  }

  input[type="file"] {
    display: none;
  }

  .file {
    -ms-flex-align: center;
    -webkit-box-align: center;
    align-items: center;
    color: rgba(0, 0, 0, 0.5);
    display: -ms-flexbox;
    display: -webkit-box;
    display: flex;
  }

  .file:hover,
  .file:focus {
    color: rgba(0, 0, 0, 0.8);
  }

  .file:active {
    color: #18a0fb;
  }

  .file svg {
    bottom: 0px;
    margin: 0;
    position: relative;
  }

  .textarea {
    -ms-flex-align: center;
    -webkit-box-align: center;
    align-items: center;
    background-color: #fff;
    border-radius: 2px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    color: rgba(0, 0, 0, 0.8);
    display: -ms-flexbox;
    display: -webkit-box;
    display: flex;
    font-family: inherit;
    font-size: inherit;
    font-weight: inherit;
    letter-spacing: inherit;
    line-height: inherit;
    margin-bottom: 1px;
    margin-top: 1px;
    min-height: 62px;
    outline: 0;
    padding: 7px 4px 7px 7px;
    resize: none;
    width: 100%;
  }

  .textarea:active,
  .textarea:focus {
    border: 2px solid #18a0fb;
    color: #000;
    padding: 6px 3px 6px 6px;
  }

  .textarea::-moz-selection {
    background-color: rgba(24, 145, 251, 0.3);
    color: #000;
  }

  .textarea::selection {
    background-color: rgba(24, 145, 251, 0.3);
    color: #000;
  }

  .textarea::-webkit-input-placeholder {
    color: rgba(0, 0, 0, 0.3);
  }

  .textarea:-ms-input-placeholder {
    color: rgba(0, 0, 0, 0.3);
  }

  .textarea::-ms-input-placeholder {
    color: rgba(0, 0, 0, 0.3);
  }

  .textarea::placeholder {
    color: rgba(0, 0, 0, 0.3);
  }

  .input {
    -ms-flex-align: center;
    -webkit-box-align: center;
    align-items: center;
    background-color: #fff;
    border-radius: 2px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    color: rgba(0, 0, 0, 0.8);
    display: -ms-flexbox;
    display: -webkit-box;
    display: flex;
    font-family: inherit;
    font-size: inherit;
    font-weight: inherit;
    height: 30px;
    letter-spacing: inherit;
    line-height: inherit;
    margin-bottom: 1px;
    margin-top: 1px;
    outline: 0;
    padding: 7px 4px 7px 7px;
    width: 100%;
  }

  .input:active,
  .input:focus {
    border: 2px solid #18a0fb;
    color: #000;
    padding: 6px 3px 6px 6px;
  }

  .input::-moz-selection {
    background-color: rgba(24, 145, 251, 0.3);
    color: #000;
  }

  .input::selection {
    background-color: rgba(24, 145, 251, 0.3);
    color: #000;
  }

  .input::-webkit-input-placeholder {
    color: rgba(0, 0, 0, 0.3);
  }

  .input:-ms-input-placeholder {
    color: rgba(0, 0, 0, 0.3);
  }

  .input::-ms-input-placeholder {
    color: rgba(0, 0, 0, 0.3);
  }

  .input::placeholder {
    color: rgba(0, 0, 0, 0.3);
  }

  .checkbox-wrapper {
    display: -ms-flexbox;
    display: -webkit-box;
    display: flex;
    padding: 1px 16px 1px 0;
  }

  .checkbox {
    height: 0;
    margin-left: 4px;
    margin-top: 4px;
    outline: 0;
    width: 0;
  }

  .checkbox:after {
    background-color: #fff;
    border-radius: 2px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    content: "";
    display: -ms-flexbox;
    display: -webkit-box;
    display: flex;
    height: 28px;
    line-height: 28px;
    margin-left: -4px;
    margin-top: -4px;
    width: 28px;
  }

  .checkbox:checked:after {
    background-color: rgba(186, 222, 254, 1);
    border: 5px solid #fff;
    height: 18px;
    margin-left: -3px;
    margin-top: -3px;
    outline: 1px solid rgba(0, 0, 0, 0.1);
    width: 18px;
  }

  .checkbox:focus:after {
    border: 1px solid #18a0fb;
  }

  .checkbox:checked:focus:after {
    border: 5px solid #fff;
    outline: 1px solid #18a0fb;
  }

  .button {
    -ms-flex-negative: 0;
    border-radius: 6px;
    border: 2px solid transparent;
    display: inline-block;
    flex-shrink: 0;
    margin-bottom: 1px;
    margin-top: 1px;
    outline: 0;
    padding: 5px 16px 5px 16px;
  }

  .button--primary {
    background-color: #18a0fb;
    color: #fff;
    font-weight: 500;
    letter-spacing: 0.01em;
  }

  .button--primary:active,
  .button--primary:focus {
    border: 2px solid rgba(0, 0, 0, 0.3);
  }

  .button--primary:disabled {
    background-color: rgba(0, 0, 0, 0.3);
  }

  .button--secondary {
    background-color: #fff;
    border: 1px solid rgba(0, 0, 0, 0.8);
    color: rgba(0, 0, 0, 0.8);
  }

  .button--secondary:active,
  .button--secondary:focus {
    border: 2px solid #18a0fb;
    padding: 4px 15px 4px 15px;
  }

  .button--secondary:disabled {
    border: 1px solid rgba(0, 0, 0, 0.3);
    color: rgba(0, 0, 0, 0.3);
  }

  .select {
    -ms-flex-align: center;
    -webkit-box-align: center;
    align-items: center;
    background-color: #fff;
    border: 1px solid rgba(0, 0, 0, 0.1);
    color: rgba(0, 0, 0, 0.8);
    display: -ms-flexbox;
    display: -webkit-box;
    display: flex;
    font-family: inherit;
    font-size: inherit;
    font-weight: inherit;
    height: 30px;
    letter-spacing: inherit;
    line-height: inherit;
    margin-bottom: 1px;
    margin-top: 1px;
    outline: none;
    width: 100%;
  }

  .select:active,
  .select:focus {
    border: 1px solid #18a0fb;
  }

  .divider {
    background-color: #e5e5e5;
    display: block;
    height: 1px;
    margin: 16px 0 8px 0;
    padding: 0;
    width: auto;
  }

  a {
    color: #18a0fb;
  }
</style>

<body>
  <div class="row">
    <div class="tab tab--active" with="translation">Translation</div>
  </div>

  <div class="container" id="translation">
    <div class="block">
      <div class="row">
        <div class="label">Dictionary</div>
        <label class="file" for="dictionaryFile" style="margin-left: auto">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            widht="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
        </label>
        <input type="file" id="dictionaryFile" />
      </div>
      <div class="row">
        <textarea class="textarea" id="serializedDictionary" wrap="off"></textarea>
      </div>
    </div>
    <div class="block">
      <div class="row">
        <div class="label">Exceptions</div>
        <label class="file" for="exceptionsFile" style="margin-left: auto">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            widht="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
        </label>
        <input type="file" id="exceptionsFile" />
      </div>
      <div class="row">
        <textarea
          class="textarea"
          id="serializedExceptions"
          wrap="off"
          placeholder="one regular expression per line..."
        ></textarea>
      </div>
      <div class="row">
        <a
          href="https://github.com/thoughteer/figma-static-localizer#exceptions"
          target="_blank"
          style="margin-left: auto"
          >What's a regular expression?</a
        >
      </div>
    </div>
    <div class="block" style="margin-top: 16px">
      <div class="row">
        <input class="input" id="sourceLanguage" />
        <div class="label">&nbsp;&rarr;&nbsp;</div>
        <input class="input" id="targetLanguage" />
        <div class="label">&nbsp;</div>
        <button class="button button--primary" id="translate" disabled>Translate</button>
      </div>
    </div>
    <div class="divider"></div>
    <div id="translationFailures"></div>
  </div>

  <script>
    var fields = null;
    var selectionFonts = [];
    var availableFonts = [];

    onmessage = (event) => {
      const message = event.data.pluginMessage;

      if (message.type === "settings") {
        fields = Object.keys(message.settings);
        fields.forEach((field) => {
          const element = document.getElementById(field);
          element.value = message.settings[field];
        });
      } else if (message.type === "translation-failures") {
        updateTranslationFailures(message.failures);
      } else if (message.type === "ready") {
        document.getElementById("translate").disabled = false;
      }
    };

    document.getElementById("dictionaryFile").onchange = (e) => loadFile(e, "serializedDictionary");
    document.getElementById("dictionaryFile").onclick = (e) => {
      e.target.value = null;
    };
    document.getElementById("exceptionsFile").onchange = (e) => loadFile(e, "serializedExceptions");
    document.getElementById("exceptionsFile").onclick = (e) => {
      e.target.value = null;
    };

    document.getElementById("translate").onclick = () => {
      document.getElementById("translate").disabled = true;
      const settings = getSettings();
      parent.postMessage({ pluginMessage: { type: "translate", settings } }, "*");
    };

    parent.postMessage({ pluginMessage: { type: "load-settings" } }, "*");
    parent.postMessage({ pluginMessage: { type: "load-available-fonts" } }, "*");
    parent.postMessage({ pluginMessage: { type: "load-selection-fonts" } }, "*");

    function getSettings() {
      const result = {};
      fields.forEach((field) => {
        const element = document.getElementById(field);
        if (element.hasAttribute("checked")) {
          result[field] = element.checked;
        } else {
          result[field] = element.value;
        }
      });
      return result;
    }

    function loadFile(e, holderId, callback) {
      const file = e.target.files[0];
      if (!file) {
        return;
      }
      const reader = new FileReader();
      reader.onload = (e) => {
        console.log(e.target.result);
        document.getElementById(holderId).value = e.target.result;
        if (callback !== undefined) {
          callback.apply();
        }
      };
      reader.readAsText(file);
    }

    function updateTranslationFailures(failures) {
      const holder = document.getElementById("translationFailures");
      holder.innerHTML = "";
      failures.map(renderError).forEach((element) => holder.appendChild(element));
      holder.appendChild(renderSuggestions(extractSuggestions(failures)));
    }

    function renderError(failure) {
      const { nodeId, error } = failure;
      const result = document.createElement("div");
      result.className = "row block";
      const link = document.createElement("a");
      link.href = 'javascript:focusNode("' + nodeId + '");';
      link.innerText = nodeId;
      const comment = document.createElement("span");
      comment.innerText = error;
      comment.appendChild(link);
      result.appendChild(comment);
      return result;
    }

    function extractSuggestions(failures) {
      const result = [];
      const unique = new Set();
      for (let failure of failures) {
        for (let suggestion of failure.suggestions) {
          if (!unique.has(suggestion)) {
            result.push(suggestion);
            unique.add(suggestion);
          }
        }
      }
      return result;
    }

    function renderSuggestions(suggestions) {
      const result = document.createElement("div");
      if (suggestions.length > 0) {
        const labelRow = document.createElement("div");
        labelRow.className = "row";
        labelRow.innerHTML = '<div class="label">We suggest to translate the following phrases</div>';
        result.appendChild(labelRow);
        const dataRow = document.createElement("div");
        dataRow.className = "row";
        const dataArea = document.createElement("textarea");
        dataArea.className = "textarea";
        dataArea.readOnly = true;
        dataArea.wrap = "off";
        dataArea.value = suggestions.join("\n");
        dataRow.appendChild(dataArea);
        result.appendChild(dataRow);
      }
      return result;
    }

    function focusNode(id) {
      parent.postMessage({ pluginMessage: { type: "focus-node", id } }, "*");
    }

    [].forEach.call(document.getElementsByClassName("tab"), (tab) => {
      if (tab.className === "tab") {
        document.getElementById(tab.getAttribute("with")).style.display = "none";
      }
      tab.onclick = () => {
        [].forEach.call(document.getElementsByClassName("tab"), (tabToHide) => {
          tabToHide.className = "tab";
          document.getElementById(tabToHide.getAttribute("with")).style.display = "none";
        });
        tab.className = "tab tab--active";
        document.getElementById(tab.getAttribute("with")).style.display = "flex";
      };
    });
  </script>
</body>
